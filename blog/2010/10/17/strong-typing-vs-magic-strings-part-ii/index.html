<!DOCTYPE html>
<html><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, user-scalable=no" name="viewport"><meta content="Strong Typing vs. Magic Strings (Part II)" name="description"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Merriweather:400,700|Open+Sans:400,700" rel="stylesheet" type="text/css"><link href="/bundles/84cd5d4454d9/styles.css" rel="stylesheet" /><title>Strong Typing vs. Magic Strings (Part II)</title></head><body><div class="row"><blockquote class="warning">This post is over 6 months old.  Some details,
       especially technical, may have changed.</blockquote><div itemscope="" itemtype="http://schema.org/Article"><h1 itemprop="name">Strong Typing vs. Magic Strings (Part II)</h1><div class="post" itemprop="articleBody">
<p>One of the problems with ASP.NET MVC is it's use of magic strings in almost every facet of the architecture.  I've mentioned this <a href="http://blogs.kainos.com/jameshu/2010/03/19/avoiding-magic-strings-in-mvc2/">before</a> but I have a few other things I'd like to mention.  In my last post I used T4MVC to generate static classes that layer on top of the magic strings but if these don't generate when you want them to they become out of sync and break compile time checking.  One solution is to generate the "proxy" files one every save however if you have a large project this could be a bit of a pain.</p><p>Other solutions exist already.  MVC2 comes with strongly typed HtmlHelpers so which turns</p><p></p><div class="highlight"><pre><code><span class="err">&lt;</span>%=Html.TextBox("FullName")%&gt;
</code></pre></div>
<p>Into,</p><p></p><div class="highlight"><pre><code><span class="err">&lt;</span>%=Html.TextBoxFor(m =&gt; m.FullName)%&gt;
</code></pre></div>
<p>Great - compile time checking and the ability to reflect things such as attribute for generating validation etc.  Problem is they didn't really do much else.  Controller methods still suffered from Magicstringitis.  RedirectToAction still needed magic strings for controller and action names and ModelState.AddModelError still needed string for property names.</p><h2>MvcContrib</h2><p><a href="http://mvccontrib.codeplex.com/Wikipage">MvcContrib</a> offers a load of non-official but excellent extensions to MVC and one of the things that comes bundled with the build is a strongly typed RedirectToAction extension method.  This lets change this,</p><p></p><div class="highlight"><pre><code><span class="k">this</span><span class="p">.</span><span class="n">RedirectToAction</span><span class="p">(</span><span class="s">"Index"</span><span class="p">,</span> <span class="s">"Home"</span><span class="p">);</span>
</code></pre></div>
<p>Into</p><p><div class="highlight"><pre><code><span class="k">this</span><span class="p">.</span><span class="n">RedirectToAction</span><span class="p">&lt;</span><span class="n">HomeController</span><span class="p">&gt;(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Index</span><span class="p">());</span>
</code></pre></div>
</p><p>Yet again  - compile time checking, refactoring support and no magic strings - Win.  But that leaves one last thing that still bugs me - ModelState.AddModelError.  To add an error for a particualr property of your model you still need to do something like this...</p><p></p><div class="highlight"><pre><code><span class="n">ModelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">(</span><span class="s">"Username"</span><span class="p">,</span> <span class="s">"Username is already in use"</span><span class="p">)</span>
</code></pre></div>
<p>YAMS! Yet another magic string!</p><h2>DIY</h2><p>Seeing as I couldn't find a solution from my good friend Google I decided to see if I could do it myself.  Turns out it's bloody easy.  This extension method will allow us to get rid of magic strings when expecting to map to a property of a simple class (such as a model or DTO)</p><p></p><div class="highlight"><pre><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// Adds a model error using strongly typed lambda expressions</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">AddModelError</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">ModelStateDictionary</span> <span class="n">modelState</span><span class="p">,</span> 
    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">method</span><span class="p">,</span> 
    <span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"method"</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">MemberExpression</span> <span class="n">mce</span> <span class="p">=</span> <span class="n">method</span><span class="p">.</span><span class="n">Body</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">property</span> <span class="p">=</span> <span class="n">mce</span><span class="p">.</span><span class="n">Member</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="n">modelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>And you can now call it like this...</p><p></p><div class="highlight"><pre><code><span class="n">ModelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">Username</span><span class="p">,</span> <span class="s">"Username already in use"</span><span class="p">);</span>
</code></pre></div>
<p>Neat!</p><p>One more bit of proof that lambda expressions are awesome - true there is reflection involved so it's going to be slower than magic strings but in my daily use I haven't really noticed any performance hits so (thanks to Jeff Atwood @ <a href="http://www.codinghorror.com">codinghorror.com</a>) I can give it a "Works on my Machine" badge.</p><p><img title="6a0120a85dcdae970b0128776ff992970c-pi[1]" src="http://codinghorror.typepad.com/.a/6a0120a85dcdae970b0128776ff992970c-pi" border="0" height="193" alt="6a0120a85dcdae970b0128776ff992970c-pi[1]" width="200" /></p></div><a class="twitter" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fyobriefca.se%2Fblog%2F2010%2F10%2F17%2Fstrong-typing-vs-magic-strings-part-ii%2F&amp;text=Strong%20Typing%20vs.%20Magic%20Strings%20%28Part%20II%29&amp;via=kouphax" itemprop="discussionUrl" target="_blank">Tweet This</a><div class="dater"><time datetime="17-10-2010" itemprop="datePublished">October 17, 2010</time></div><div class="categories">Published in <a href="/categories/dot-net/">.NET</a> on October 17, 2010</div></div></div><div class="homer"><a href="/"><i class="icon-briefcase" style="font-size:32px;"></i></a></div><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19143623-5', 'yobriefca.se');
  ga('send', 'pageview');</script></body></html>