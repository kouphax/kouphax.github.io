<!DOCTYPE html>
<html><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, user-scalable=no" name="viewport"><meta content="Building Command Line Apps with Clojure" name="description"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Merriweather:400,700|Open+Sans:400,700" rel="stylesheet" type="text/css"><link href="/bundles/84cd5d4454d9/styles.css" rel="stylesheet" /><title>Building Command Line Apps with Clojure</title></head><body><div class="row"><blockquote class="warning">This post is over 6 months old.  Some details,
       especially technical, may have changed.</blockquote><div itemscope="" itemtype="http://schema.org/Article"><h1 itemprop="name">Building Command Line Apps with Clojure</h1><div class="post" itemprop="articleBody"><p>I recently read an article by <a href="http://rkn.io">Ryan Neufeld</a> around <a href="http://www.rkn.io/2014/02/27/clojure-cookbook-command-line-args/">parsing command line arguments with Clojure</a>. It's a good article and you should read it if the idea of building command line utilities in Clojure floats your boat.</p><p>To complement that article I've decided to take the building of the command line app one step further and support running your creation as a standalone command. Of course its possible, as demonstrated in the article, to run the app using Leiningen directly but you typically want to be bundling your app into a self conatined package (minus any necessary runtimes - in our case the JVM) for deployment to other environments.</p><p>So lets start were Ryans article left off, a simple command line app that can be run via Leiningen. The <code>core.clj</code> looks like this,</p>
<pre class="highlight"><code class="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">runs.core</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.tools.cli</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">cli</span><span class="p">]])</span>
  <span class="p">(</span><span class="ss">:gen-class</span><span class="p">))</span>


<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">opts</span> <span class="nv">args</span> <span class="nv">banner</span><span class="p">]</span> <span class="p">(</span><span class="nf">cli</span> <span class="nv">args</span>
                                <span class="p">[</span><span class="s">"-h"</span> <span class="s">"--help"</span> <span class="s">"Print this help"</span>
                                 <span class="ss">:default</span> <span class="nv">false</span> <span class="ss">:flag</span> <span class="nv">true</span><span class="p">])]</span>
    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:help</span> <span class="nv">opts</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">println </span><span class="nv">banner</span><span class="p">))))</span>
</code></pre><p>And the <code>project.clj</code> looks like this</p>
<pre class="highlight"><code class="clojure"><span class="p">(</span><span class="kd">defproject </span><span class="nv">runs</span> <span class="s">"0.1.0-SNAPSHOT"</span>
  <span class="ss">:description</span> <span class="s">"FIXME: write description"</span>
  <span class="ss">:url</span> <span class="s">"http://example.com/FIXME"</span>
  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">"Eclipse Public License"</span>
            <span class="ss">:url</span> <span class="s">"http://www.eclipse.org/legal/epl-v10.html"</span><span class="p">}</span>
  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">"1.5.1"</span><span class="p">]</span>
                 <span class="p">[</span><span class="nv">org.clojure/tools.cli</span> <span class="s">"0.2.4"</span><span class="p">]]</span>
  <span class="ss">:main</span> <span class="nv">runs.core</span><span class="p">)</span>
</code></pre><p>As Ryans article mentions we can run this via <code>lein run</code> and pass our arguments in.</p>
<pre class="highlight"><code class="bash">lein run -- -h
</code></pre><h2>Uberjar</h2><p>First thing we want to do is take Leiningen out of the equation and bundle the app as a standalone JAR. Unlike other JVM build tools that need to be extended with plugins such as <a href="http://maven.apache.org/plugins/maven-shade-plugin/">shade</a>, <a href="http://one-jar.sourceforge.net/">onejar</a> and <a href="https://github.com/sbt/sbt-assembly">assembly</a> Leingingen comes with <code>uberjar</code> prebundled. To create a basic uberjar, a JAR containting your application code and all the necessary dependencies, we can call <code>lein uberjar</code>. There are also a bunch of configuration options that go along with uberjar but what we have specified is sufficient to build our jar. The JAR will be output to <code>target</code> dir appended with <code>-standalone</code>. We can run this JAR using via the usual Java way</p>
<pre class="highlight"><code class="bash">java -jar target/app-0.1.0-SNAPSHOT-standalone.jar -h
</code></pre><h2>lein-bin</h2><p>I don't know about you but I'm lazy and I like my commands names to represent what they do (roughly) so the thought of running <code>java -jar blahblah.jar -h</code> every time I want to run the command is just "meh". We could write a shell script to run the more verbose command but thats less than ideal (it's messy and on top of my laziness I'm a tad OCD about carting around wrapper scripts).</p><p>Enter <a href="https://github.com/Raynes/lein-bin">lein-bin</a> a Leiningen plugin that utilises the fact ZIP files and therefore JARs can have stuff prepended to the front of it. What it does is prepend shell commands to your JAR making it executable in and of itself.</p><p>So to use <code>lein-bin</code> we need to add the plugin to our projects <code>project.clj</code> or the global Leiningen profile (<code>~/.lein/profiles.clj</code>)</p>
<pre class="highlight"><code class="clojure"><span class="p">{</span> <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-bin</span> <span class="s">"0.3.4"</span><span class="p">]]</span> <span class="p">}</span>
</code></pre><p>We can also add some <code>lein-bin</code> related configuration like changing the output name (there are some other options as well, all noted in the <code>lein-bin</code> <a href="https://github.com/Raynes/lein-bin/blob/master/README.markdown">README</a>)</p>
<pre class="highlight"><code class="clojure"><span class="ss">:bin</span> <span class="p">{</span> <span class="ss">:name</span> <span class="s">"runs"</span> <span class="p">})</span>
</code></pre><p>So running <code>lein bin</code> now leaves us with another file in <code>target</code> called <code>runs</code> that is executable.</p>
<pre class="highlight"><code class="clojure"><span class="nv">target/runs</span> <span class="nv">-h</span>
</code></pre><p>Now we've got a command line util called <code>runs</code> (yeah a terrible name) rather than some verbose Java command or being force to use a build tool on all environments. It's the little things.</p></div><a class="twitter" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fyobriefca.se%2Fblog%2F2014%2F03%2F02%2Fbuilding-command-line-apps-with-clojure%2F&amp;text=Building%20Command%20Line%20Apps%20with%20Clojure&amp;via=kouphax" itemprop="discussionUrl" target="_blank">Tweet This</a><div class="dater"><time datetime="02-03-2014" itemprop="datePublished">March 02, 2014</time></div><div class="categories">Published in <a href="/categories/clojure/">Clojure</a> on March 02, 2014</div></div></div><div class="homer"><a href="/"><i class="icon-briefcase" style="font-size:32px;"></i></a></div><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19143623-5', 'yobriefca.se');
  ga('send', 'pageview');</script></body></html>